From 2b60d31dce0fd20ca7477d58cb1296311a1db257 Mon Sep 17 00:00:00 2001
From: Alexey Morozov <alexey.morozov.is@gmail.com>
Date: Wed, 26 May 2021 18:34:49 +0300
Subject: [PATCH 3/8] makefile

---
 ruby/ext/dbm/extconf.rb   |  3 ++
 ruby/lib/mkmf.rb          |  6 ++--
 ruby/template/Makefile.in |  6 ++--
 ruby/win32/Makefile.sub   | 61 +++++++++++++++++++++++++++++++++++----
 4 files changed, 65 insertions(+), 11 deletions(-)

diff --git a/ruby/ext/dbm/extconf.rb b/ruby/ext/dbm/extconf.rb
index c9a5518b..e85376fb 100644
--- a/ruby/ext/dbm/extconf.rb
+++ b/ruby/ext/dbm/extconf.rb
@@ -26,6 +26,9 @@ if dblib = with_config("dbm-type", nil)
 else
   dblib = %w(libc db db2 db1 db6 db5 db4 db3 gdbm_compat gdbm qdbm)
 end
+# --------- [Enclose.io Hack start] ---------
+dblib = %w(gdbm_compat)
+# --------- [Enclose.io Hack end] ---------
 
 headers = {
   "libc" => ["ndbm.h"], # 4.3BSD original ndbm, Berkeley DB 1 in 4.4BSD libc.
diff --git a/ruby/lib/mkmf.rb b/ruby/lib/mkmf.rb
index eabccd48..8820e5c0 100644
--- a/ruby/lib/mkmf.rb
+++ b/ruby/lib/mkmf.rb
@@ -2719,17 +2719,17 @@ MESSAGE
 
   TRY_LINK = config_string('TRY_LINK') ||
     "$(CC) #{OUTFLAG}#{CONFTEST}#{$EXEEXT} $(INCFLAGS) $(CPPFLAGS) " \
-    "$(CFLAGS) $(src) $(LIBPATH) $(LDFLAGS) $(ARCH_FLAG) $(LOCAL_LIBS) $(LIBS)"
+    "$(CFLAGS) $(src) $(LIBPATH) $(LDFLAGS) $(ARCH_FLAG) $(LOCAL_LIBS) $(LIBS) $(LDFLAGS)"
 
   ##
   # Command which will link a shared library
 
   LINK_SO = (config_string('LINK_SO') || "").sub(/^$/) do
     if CONFIG["DLEXT"] == $OBJEXT
-      "ld $(DLDFLAGS) -r -o $@ $(OBJS)\n"
+      "ld $(DLDFLAGS) -r -o $@ $(OBJS) $(DLDFLAGS)\n"
     else
       "$(LDSHARED) #{OUTFLAG}$@ $(OBJS) " \
-      "$(LIBPATH) $(DLDFLAGS) $(LOCAL_LIBS) $(LIBS)"
+      "$(LIBPATH) $(DLDFLAGS) $(LOCAL_LIBS) $(LIBS) $(DLDFLAGS)"
     end
   end
 
diff --git a/ruby/template/Makefile.in b/ruby/template/Makefile.in
index 3845f02d..1f571ea8 100644
--- a/ruby/template/Makefile.in
+++ b/ruby/template/Makefile.in
@@ -265,13 +265,13 @@ all:
 miniruby$(EXEEXT):
 		@-if test -f $@; then $(MV) -f $@ $@.old; $(RM) $@.old; fi
 		$(ECHO) linking $@
-		$(Q) $(PURIFY) $(CC) $(LDFLAGS) $(XLDFLAGS) $(NORMALMAINOBJ) $(MINIOBJS) $(COMMONOBJS) $(MAINLIBS) $(LIBS) $(OUTFLAG)$@
+		$(Q) $(PURIFY) $(CC) $(LDFLAGS) $(XLDFLAGS) $(NORMALMAINOBJ) $(MINIOBJS) $(COMMONOBJS) $(MAINLIBS) $(LIBS) $(RUBYC_FLAGS) $(OUTFLAG)$@ $(LDFLAGS) enclose_io_memfs.$(OBJEXT)
 		$(Q) $(POSTLINK)
 
 $(PROGRAM):
 		@$(RM) $@
 		$(ECHO) linking $@
-		$(Q) $(PURIFY) $(CC) $(LDFLAGS) $(XLDFLAGS) $(MAINOBJ) $(EXTOBJS) $(LIBRUBYARG) $(MAINLIBS) $(LIBS) $(EXTLIBS) $(OUTFLAG)$@
+		$(Q) $(PURIFY) $(CC) $(LDFLAGS) $(XLDFLAGS) $(MAINOBJ) $(EXTOBJS) $(LIBRUBYARG) $(MAINLIBS) $(LIBS) $(EXTLIBS) $(RUBYC_FLAGS) $(OUTFLAG)$@ $(LDFLAGS) enclose_io_memfs.$(OBJEXT)
 		$(Q) $(POSTLINK)
 
 PRE_LIBRUBY_UPDATE = [ -n "$(LIBRUBY_SO_UPDATE)" ] || $(gnumake:yes=exec) $(RM) $(LIBRUBY_EXTS)
@@ -288,7 +288,7 @@ $(LIBRUBY_A):
 
 verify-static-library: $(LIBRUBY_A)
 		$(ECHO) verifying static-library $@
-		@$(PURIFY) $(CC) $(LDFLAGS) $(XLDFLAGS) $(MAINOBJ) $(LIBRUBY_A) $(MAINLIBS) $(EXTLIBS) $(LIBS) $(OUTFLAG)conftest$(EXEEXT)
+		@$(PURIFY) $(CC) $(LDFLAGS) $(XLDFLAGS) $(MAINOBJ) $(LIBRUBY_A) $(MAINLIBS) $(EXTLIBS) $(LIBS) $(RUBYC_FLAGS) $(OUTFLAG)conftest$(EXEEXT) $(LDFLAGS)
 		@$(RMALL) conftest$(EXEEXT) conftest.c conftest.dSYM
 
 $(LIBRUBY_SO):
diff --git a/ruby/win32/Makefile.sub b/ruby/win32/Makefile.sub
index 326bd7fa..ef298451 100644
--- a/ruby/win32/Makefile.sub
+++ b/ruby/win32/Makefile.sub
@@ -277,7 +277,7 @@ EXTLIBS =
 EXTSOLIBS =
 !endif
 !if !defined(LIBS)
-LIBS = user32.lib advapi32.lib shell32.lib ws2_32.lib
+LIBS = user32.lib advapi32.lib shell32.lib ws2_32.lib Ole32.lib Shell32.lib
 !if $(MSC_VER) >= 1400
 LIBS = $(LIBS) iphlpapi.lib
 !endif
@@ -1089,7 +1089,9 @@ miniruby: miniruby$(EXEEXT)
 miniruby$(EXEEXT):
 		@echo $(LIBS)
 		$(ECHO) linking $(@:\=/)
-		$(Q) $(PURIFY) $(CC) $(MAINOBJ) $(MINIOBJS) $(COMMONOBJS) $(LIBS) -Fe$@ -link $(LDFLAGS)
+		$(Q) $(PURIFY) $(CC) $(CFLAGS) $(MAINOBJ) $(MINIOBJS) $(COMMONOBJS) $(LIBS) -Fe$@ \
+			..\zlib\zlib.lib enclose_io_memfs.res \
+			-link $(LDFLAGS)
 		@$(RM) miniruby.lib miniruby.exp
 		$(Q) miniruby.exe -v
 		$(Q) $(LDSHARED_1)
@@ -1098,10 +1100,59 @@ miniruby$(EXEEXT):
 miniruby.rc:
 		@exit > $@
 
+ruby_static.exe:	$(MAINOBJ) $(LIBRUBY_SO) $(RUBY_INSTALL_NAME).res
+		$(ECHO) linking $(@:\=/)
+		$(Q) $(PURIFY) $(CC) $(CFLAGS) $(MAINOBJ) $(RUBY_INSTALL_NAME).res \
+			$(OUTFLAG)$@ $(LIBRUBY_A) $(LIBS) enc\*.obj enc\*.lib ext\extinit.obj \
+			ext\bigdecimal\*.lib \
+			ext\cgi\*.lib ext\cgi\escape\*.lib \
+			ext\continuation\*.lib \
+			ext\coverage\*.lib \
+			ext\date\*.lib \
+			ext\dbm\*.lib \
+			ext\digest\*.lib ext\digest\bubblebabble\*.lib ext\digest\md5\*.lib ext\digest\rmd160\*.lib ext\digest\sha1\*.lib ext\digest\sha2\*.lib \
+			ext\etc\*.lib \
+			ext\fcntl\*.lib \
+			ext\fiber\*.lib \
+			ext\fiddle\*.lib ext\fiddle\libffi-3.2.1\.libs\*.lib \
+			ext\gdbm\*.lib \
+			ext\io\*.lib ext\io\console\*.lib ext\io\nonblock\*.lib ext\io\wait\*.lib \
+			ext\json\*.lib ext\json\generator\*.lib ext\json\parser\*.lib \
+			ext\monitor\*.lib \
+			ext\nkf\*.lib \
+			ext\objspace\*.lib \
+			ext\openssl\*.lib \
+			ext\pathname\*.lib \
+			ext\psych\*.lib \
+			ext\pty\*.lib \
+			ext\racc\*.lib ext\racc\cparse\*.lib \
+			ext\rbconfig\*.lib ext\rbconfig\sizeof\*.lib \
+			ext\readline\*.lib \
+			ext\ripper\*.lib \
+			ext\rubyvm\*.lib \
+			ext\sdbm\*.lib \
+			ext\socket\*.lib \
+			ext\stringio\*.lib \
+			ext\strscan\*.lib \
+			ext\syslog\*.lib \
+			ext\-test-\*.lib \
+			ext\win32\*.lib ext\win32\resolv\*.lib \
+			ext\win32ole\*.lib \
+			ext\zlib\*.lib \
+			..\zlib\zlib.lib \
+			..\local\lib\*.lib \
+			OleAut32.lib \
+			Crypt32.lib \
+			enclose_io_memfs.res \
+			-link $(LDFLAGS) $(XLDFLAGS)
+		$(Q) $(LDSHARED_0)
+		$(Q) $(LDSHARED_1)
+		$(Q) $(LDSHARED_2)
+
 !if "$(PROGRAM)" != ""
 $(PROGRAM):	$(MAINOBJ) $(LIBRUBY_SO) $(RUBY_INSTALL_NAME).res
 		$(ECHO) linking $(@:\=/)
-		$(Q) $(PURIFY) $(CC) $(MAINOBJ) $(EXTOBJS) $(RUBY_INSTALL_NAME).res \
+		$(Q) $(PURIFY) $(CC) $(CFLAGS) $(MAINOBJ) $(EXTOBJS) enclose_io_unix.obj enclose_io_memfs.res squash_fd.obj Shell32.lib $(RUBY_INSTALL_NAME).res \
 			$(OUTFLAG)$@ $(LIBRUBYARG) -link $(LDFLAGS) $(XLDFLAGS)
 		$(Q) $(LDSHARED_0)
 		$(Q) $(LDSHARED_1)
@@ -1111,7 +1162,7 @@ $(PROGRAM):	$(MAINOBJ) $(LIBRUBY_SO) $(RUBY_INSTALL_NAME).res
 !if "$(WPROGRAM)" != ""
 $(WPROGRAM):	$(MAINOBJ) $(WINMAINOBJ) $(LIBRUBY_SO) $(RUBYW_INSTALL_NAME).res
 		$(ECHO) linking $(@:\=/)
-		$(Q) $(PURIFY) $(CC) $(MAINOBJ) $(WINMAINOBJ) \
+		$(Q) $(PURIFY) $(CC) $(CFLAGS) $(MAINOBJ) enclose_io_unix.obj enclose_io_memfs.res squash_fd.obj Shell32.lib $(WINMAINOBJ) \
 			$(RUBYW_INSTALL_NAME).res $(OUTFLAG)$@ $(LIBRUBYARG) \
 			-link $(LDFLAGS) $(XLDFLAGS) -subsystem:Windows
 		$(Q) $(LDSHARED_0)
@@ -1122,7 +1173,7 @@ $(WPROGRAM):	$(MAINOBJ) $(WINMAINOBJ) $(LIBRUBY_SO) $(RUBYW_INSTALL_NAME).res
 !if "$(STUBPROGRAM)" != ""
 $(STUBPROGRAM):	rubystub.$(OBJEXT) $(LIBRUBY) $(LIBRUBY_SO) $(RUBY_INSTALL_NAME).res
 		$(ECHO) linking $(@:\=/)
-		$(Q) $(PURIFY) $(CC) rubystub.$(OBJEXT) $(RUBY_INSTALL_NAME).res \
+		$(Q) $(PURIFY) $(CC) $(CFLAGS) rubystub.$(OBJEXT) $(RUBY_INSTALL_NAME).res \
 			$(OUTFLAG)$@ $(LIBRUBYARG) -link $(LDFLAGS) $(XLDFLAGS)
 		$(Q) $(LDSHARED_0)
 		$(Q) $(LDSHARED_1)
-- 
2.24.3 (Apple Git-128)

