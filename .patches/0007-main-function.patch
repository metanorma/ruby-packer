From 57b1514942ef8b63386ad548309504e5fe1ceef4 Mon Sep 17 00:00:00 2001
From: Alexey Morozov <alexey.morozov.is@gmail.com>
Date: Wed, 26 May 2021 18:59:02 +0300
Subject: [PATCH 7/7] main function

---
 ruby/main.c | 89 +++++++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 89 insertions(+)

diff --git a/ruby/main.c b/ruby/main.c
index 095c19c4..94c69262 100644
--- a/ruby/main.c
+++ b/ruby/main.c
@@ -19,9 +19,98 @@
 #include <stdlib.h>
 #endif
 
+// --------- [Enclose.io Hack start] ---------
+#include "enclose_io.h"
+#ifdef _WIN32
+#include <direct.h>
+#else
+#include <unistd.h>
+#endif
+extern SQUASH_OS_PATH mkdir_workdir;
+extern char *enclose_io_mkdir_scope;
+// --------- [Enclose.io Hack end] ---------
+
 int
 main(int argc, char **argv)
 {
+// --------- [Enclose.io Hack start] ---------
+	int ret;
+	sqfs_err enclose_io_ret;
+#ifdef _WIN32
+	BOOL bool_ret;
+#else
+	int new_argc;
+	char **new_argv;
+	char *argv_memory;
+	size_t i;
+	size_t total_argv_size;
+#endif
+
+	enclose_io_ret = squash_start();
+	assert(SQFS_OK == enclose_io_ret);
+	enclose_io_fs = malloc(sizeof(sqfs));
+	assert(NULL != enclose_io_fs);
+	memset(enclose_io_fs, 0, sizeof(sqfs));
+	enclose_io_ret = sqfs_open_image(enclose_io_fs, enclose_io_memfs, 0);
+	assert(SQFS_OK == enclose_io_ret);
+
+#ifdef _WIN32
+	if (NULL == getenv("RUBY_PACKER_USE_ORIGINAL_RUBY")) {
+#ifdef RUBY_PACKER_ENV_BUNDLE_GEMFILE
+		bool_ret = SetEnvironmentVariable("BUNDLE_GEMFILE", RUBY_PACKER_ENV_BUNDLE_GEMFILE);
+		assert(0 != bool_ret);
+#endif // RUBY_PACKER_ENV_BUNDLE_GEMFILE
+#ifdef RUBY_PACKER_RAILS
+		assert(NULL == mkdir_workdir);
+		enclose_io_mkdir_scope = "/__enclose_io_memfs__/local";
+		bool_ret = SetEnvironmentVariable("RUBY_PACKER_RAILS", "1");
+		assert(0 != bool_ret);
+#endif // RUBY_PACKER_RAILS
+	}
+#else // ifdef _WIN32 -----------------------------------------------
+#ifdef RUBY_PACKER_ENTRANCE
+	new_argc = argc;
+	new_argv = argv;
+	argv_memory = NULL;
+	if (NULL == getenv("RUBY_PACKER_USE_ORIGINAL_RUBY")) {
+#ifdef RUBY_PACKER_ENV_BUNDLE_GEMFILE
+		ret = setenv("BUNDLE_GEMFILE", RUBY_PACKER_ENV_BUNDLE_GEMFILE, 1);
+		assert(0 == ret);
+#endif // RUBY_PACKER_ENV_BUNDLE_GEMFILE
+#ifdef RUBY_PACKER_RAILS
+		assert(NULL == mkdir_workdir);
+		enclose_io_mkdir_scope = "/__enclose_io_memfs__/local";
+		ret = setenv("RUBY_PACKER_RAILS", "1", 1);
+		assert(0 == ret);
+#endif // RUBY_PACKER_RAILS
+		new_argv = (char **)malloc( (argc + 1) * sizeof(char *));
+		assert(new_argv);
+		new_argv[0] = argv[0];
+		new_argv[1] = RUBY_PACKER_ENTRANCE;
+		for (i = 1; i < argc; ++i) {
+			new_argv[2 + i - 1] = argv[i];
+		}
+		new_argc = argc + 1;
+		/* argv memory should be adjacent. */
+		total_argv_size = 0;
+		for (i = 0; i < new_argc; ++i) {
+			total_argv_size += strlen(new_argv[i]) + 1;
+		}
+		argv_memory = (char *)malloc( (total_argv_size) * sizeof(char));
+		assert(argv_memory);
+		for (i = 0; i < new_argc; ++i) {
+			memcpy(argv_memory, new_argv[i], strlen(new_argv[i]) + 1);
+			new_argv[i] = argv_memory;
+			argv_memory += strlen(new_argv[i]) + 1;
+		}
+		assert(argv_memory - new_argv[0] == total_argv_size);
+		argc = new_argc;
+		argv = new_argv;
+	}
+#endif // RUBY_PACKER_ENTRANCE
+#endif // ifdef _WIN32
+// --------- [Enclose.io Hack end] ---------
+
 #ifdef RUBY_DEBUG_ENV
     ruby_set_debug_option(getenv("RUBY_DEBUG"));
 #endif
-- 
2.24.3 (Apple Git-128)

